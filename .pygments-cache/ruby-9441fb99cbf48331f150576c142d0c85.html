<div class="highlight"><pre><span class="nb">require</span> <span class="err">‘</span><span class="no">Digest</span><span class="err">’</span>
<span class="k">def</span> <span class="nf">gsub_links</span><span class="p">(</span><span class="n">conetnt</span><span class="p">,</span> <span class="n">domain</span><span class="p">)</span>
  <span class="n">hash_links</span> <span class="o">=</span> <span class="p">{}</span>
  <span class="n">time</span> <span class="o">=</span> <span class="no">Time</span><span class="o">.</span><span class="n">now</span>
  <span class="n">links_arr</span> <span class="o">=</span> <span class="n">content</span><span class="o">.</span><span class="n">scan</span><span class="p">(</span><span class="sr">/&amp;lt;a.&lt;em&gt;?href=([’”])(.&lt;/em</span><span class="o">&gt;</span><span class="sc">?)</span><span class="p">\</span><span class="mi">1</span><span class="o">.</span><span class="n">&lt;em</span><span class="o">&gt;</span><span class="p">?</span><span class="o">&amp;</span><span class="n">gt</span><span class="p">;</span><span class="o">/</span><span class="p">)</span><span class="o">.</span><span class="n">map</span> <span class="p">{</span><span class="o">|</span><span class="n">m</span><span class="o">|</span> <span class="n">m</span><span class="o">[</span><span class="mi">1</span><span class="o">]</span> <span class="p">}</span>
  <span class="n">links_arr</span><span class="o">.</span><span class="n">each</span> <span class="k">do</span> <span class="o">|</span><span class="n">l</span><span class="o">|</span>
    <span class="n">hash_links</span><span class="o">[</span><span class="err">”</span><span class="c1">#{l}”] = Digest::SHA1.hexdigest(l+time.to_s)[8..16]</span>
  <span class="k">end</span>
  <span class="n">content</span><span class="o">.</span><span class="n">gsub!</span><span class="p">(</span><span class="sr">/&amp;lt;a.&lt;/em</span><span class="o">&gt;</span><span class="p">?</span><span class="n">href</span><span class="o">=</span><span class="p">(</span><span class="o">[</span><span class="err">’”</span><span class="o">]</span><span class="p">)(</span><span class="o">.</span><span class="n">&lt;em</span><span class="o">&gt;</span><span class="sc">?)</span><span class="p">\</span><span class="mi">1</span><span class="o">.</span><span class="n">&lt;</span><span class="sr">/em&gt;?&amp;gt;/</span><span class="p">){</span><span class="o">|</span><span class="n">s</span><span class="o">|</span><span class="n">s</span><span class="o">.</span><span class="n">gsub</span><span class="p">(</span><span class="vg">$2</span><span class="p">,</span> <span class="err">“</span><span class="c1">#{domain}/#{Digest::SHA1.hexdigest($2+time.to_s)[8..16]}”)}</span>
<span class="k">end</span><span class="o">&lt;</span><span class="sr">/p&gt;</span>

<span class="sr">&lt;p&gt;</span>
</pre></div>