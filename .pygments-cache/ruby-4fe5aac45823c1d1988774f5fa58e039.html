<div class="highlight"><pre><span class="nb">require</span> <span class="s1">&#39;Digest&#39;</span>
<span class="k">def</span> <span class="nf">gsub_links</span><span class="p">(</span><span class="n">conetnt</span><span class="p">,</span> <span class="n">domain</span><span class="p">)</span>
  <span class="n">hash_links</span> <span class="o">=</span> <span class="p">{}</span>
  <span class="n">time</span> <span class="o">=</span> <span class="no">Time</span><span class="o">.</span><span class="n">now</span>
  <span class="n">links_arr</span> <span class="o">=</span> <span class="n">content</span><span class="o">.</span><span class="n">scan</span><span class="p">(</span><span class="sr">/&lt;a.*?href=([&#39;&quot;])(.*?)\1.*?&gt;/</span><span class="p">)</span><span class="o">.</span><span class="n">map</span> <span class="p">{</span><span class="o">|</span><span class="n">m</span><span class="o">|</span> <span class="n">m</span><span class="o">[</span><span class="mi">1</span><span class="o">]</span> <span class="p">}</span>
  <span class="n">links_arr</span><span class="o">.</span><span class="n">each</span> <span class="k">do</span> <span class="o">|</span><span class="n">l</span><span class="o">|</span>
    <span class="n">hash_links</span><span class="o">[</span><span class="s2">&quot;</span><span class="si">#{</span><span class="n">l</span><span class="si">}</span><span class="s2">&quot;</span><span class="o">]</span> <span class="o">=</span> <span class="ss">Digest</span><span class="p">:</span><span class="ss">:SHA1</span><span class="o">.</span><span class="n">hexdigest</span><span class="p">(</span><span class="n">l</span><span class="o">+</span><span class="n">time</span><span class="o">.</span><span class="n">to_s</span><span class="p">)</span><span class="o">[</span><span class="mi">8</span><span class="o">.</span><span class="n">.</span><span class="mi">16</span><span class="o">]</span>
  <span class="k">end</span>
  <span class="n">content</span><span class="o">.</span><span class="n">gsub!</span><span class="p">(</span><span class="sr">/&lt;a.*?href=([&#39;&quot;])(.*?)\1.*?&gt;/</span><span class="p">){</span><span class="o">|</span><span class="n">s</span><span class="o">|</span><span class="n">s</span><span class="o">.</span><span class="n">gsub</span><span class="p">(</span><span class="vg">$2</span><span class="p">,</span> <span class="s2">&quot;</span><span class="si">#{</span><span class="n">domain</span><span class="si">}</span><span class="s2">/</span><span class="si">#{</span><span class="ss">Digest</span><span class="p">:</span><span class="ss">:SHA1</span><span class="o">.</span><span class="n">hexdigest</span><span class="p">(</span><span class="vg">$2</span><span class="o">+</span><span class="n">time</span><span class="o">.</span><span class="n">to_s</span><span class="p">)</span><span class="o">[</span><span class="mi">8</span><span class="o">.</span><span class="n">.</span><span class="mi">16</span><span class="o">]</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)}</span>
<span class="k">end</span>
</pre></div>